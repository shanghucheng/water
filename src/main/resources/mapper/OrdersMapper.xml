<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.water.mapper.OrdersMapper">
    <resultMap id="BaseResultMap" type="com.water.entity.Orders">
        <!--
          WARNING - @mbg.generated
        -->
        <id column="id" property="id" jdbcType="INTEGER"/>
        <result column="userId" property="userid" jdbcType="INTEGER"/>
        <result column="addressId" property="addressid" jdbcType="INTEGER"/>
        <result column="totalNum" property="totalnum" jdbcType="VARCHAR"/>
        <result column="totalPrice" property="totalprice" jdbcType="VARCHAR"/>
        <result column="orderDate" property="orderdate" jdbcType="VARCHAR"/>
        <result column="orderState" property="orderstate" jdbcType="VARCHAR"/>
    </resultMap>
    <insert id="insertOrder" parameterType="com.water.entity.Orders" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO `water`.`orders` (`userId`, addressId, `totalNum`, `totalPrice`, `orderDate`, `orderState`)
        VALUES
        (#{userid}, #{addressid}, #{totalnum}, #{totalprice}, #{orderdate}, #{orderstate});
    </insert>
    <select id="getOrder" parameterType="String" resultMap="BaseResultMap">
        SELECT
        id,
        userId,
        totalNum,
        totalPrice,
        orderDate,
        orderState
        FROM
        orders
        WHERE
        userId = #{userid}
        <if test="orderstate!='' and orderstate!=null">
            AND orderState =#{orderstate}
        </if>
        ORDER BY
        id DESC
    </select>

    <select id="getOrderById" parameterType="String" resultMap="BaseResultMap">
        SELECT
            id,
            userId,
            addressId,
            totalNum,
            totalPrice,
            orderDate,
            orderState
        FROM
            `orders`
        WHERE
            id = #{id}
    </select>

    <select id="getOrderByState" parameterType="String" resultType="map">
        SELECT
            concat( orders.id, '' ) id,
            concat( orders.userId, '' ) userId,
            concat( orders.addressId, '' ) addressId,
            orders.totalNum,
            orders.totalPrice,
            orders.orderDate,
            orders.orderState,
            address.userName,
            address.telNumber,
            address.provinceName,
            address.cityName,
            address.countyName,
            address.detailInfo
        FROM
            `orders`
                LEFT JOIN address ON address.id = orders.addressId
        WHERE
            orders.orderState = 5
    </select>

    <update id="updateOrderStateById" parameterType="String">
        UPDATE `water`.`orders`
        SET `orderState` = #{orderstate}
        WHERE
            `id` = #{id}
    </update>

    <select id="getRiderOrderDetailById" parameterType="String" resultType="map">
        SELECT
            concat( orders.id, '' ) orderId,
            concat( orders.userId, '' ) userId,
            concat( orders.addressId, '' ) addressId,
            orders.totalNum,
            orders.totalPrice,
            orders.orderDate,
            riderorder.orderTime,
            orders.orderState,
            concat(TIMESTAMPDIFF( MINUTE, ( DATE_FORMAT( orders.orderDate, '%Y-%m-%d %H:%i' ) ), ( DATE_FORMAT( riderorder.orderTime, '%Y-%m-%d %H:%i' ) ) ),'') sendTime,
            waterinfo.name,
            waterinfo.url,
            ordersdetail.goodsNum,
            ordersdetail.goodsPrice,
            address.userName,
            address.telNumber,
            address.provinceName,
            address.cityName,
            address.countyName,
            address.detailInfo
        FROM
            orders
                LEFT JOIN riderorder ON riderorder.orderId = orders.id
                LEFT JOIN ordersdetail ON ordersdetail.orderId = orders.id
                LEFT JOIN waterinfo ON ordersdetail.waterId = waterinfo.id
                LEFT JOIN address ON address.id = orders.addressId
        WHERE
            orders.id = #{orderid}
          AND riderorder.riderId =#{riderid}
    </select>
</mapper>